













#include	<stdio.h>
#include	<stdlib.h>
#include	<string.h>
#include	<ctype.h>
#include	<errno.h>
#include	<err.h>

#include	<time.h>
#include	<sys/timeb.h>

#include	<syslog.h>

#include	<sys/stat.h>
#include	<sys/types.h>
#include	<fcntl.h>
#include	<sys/ipc.h>
#include	<sys/msg.h>

#include	<syslog.h>
#include	<stdarg.h>

#include	<sqlca.h>
EXEC SQL BEGIN DECLARE SECTION;
#include	"merit_bat.h"
EXEC SQL END DECLARE SECTION;








int		main( int, char** );
void	exit_proc();




extern FILE *yyin;
extern PROC_COM_PARAM	G_PROC_COM_PARAM;
extern CMD_COM_PARAM	G_CMD_COM_PARAM;
extern CMD_SC_PARAM     G_CMD_SC_PARAM;      
extern CMD_SA_PARAM     G_CMD_SA_PARAM;      
extern CMD_BT_PARAM     G_CMD_BT_PARAM;      
extern CMD_XX_PARAM     G_CMD_XX_PARAM;      
extern CMD_C30X1_PARAM  G_CMD_SS_PARAM;
extern CMD_C30X1_PARAM  G_CMD_SR_PARAM;
extern CMD_C30X1_PARAM  G_CMD_SG_PARAM;
extern CMD_C30X1_PARAM  G_CMD_SU_PARAM;
extern CMD_HANYO06_PARAM  G_CMD_FDFR_REC[MAX_FDFR_REC];

extern void init_cmd_param();




static char	*p_eventcd =	"01";
static char	*p_progid = "ml_ent01";
static int	lockfd;					

int isTimer(char *str,char *stp)
{
	if(0 == strcmp(str,"9999")
	|| 0 == strcmp(stp,"9999")
	|| 0x00 == str[0]
	|| 0x00 == stp[0] ){
		return 0;
	}
	time_t timer;
	struct tm *date;					
	char dtbuff[10+1];
	
	timer = time(NULL);          
    date = localtime(&timer);    
	strftime(dtbuff, 5, "%H%M\0", date);
	
    if(-1 == strcmp(dtbuff,str)
    || 1 == strcmp(dtbuff,stp) ){
		return 0;
	}
	return 1;
}

int isPauseTimer(ENVDATA* p_env)
{
	int i = 0;
	char *str,*stp;
	
	for(i;i<PAUSE_TIMES_MAX;i++){
		str = p_env->pause_str_times[i];
		stp = p_env->pause_stp_times[i];
		
		if(0x00 == str[0]
		|| 0x00 == stp[0] ){
			return 0;
		}
		if(isTimer(str,stp)){
			return 1;
		}
	}
	return 0;
}


void tlog(char *p,ENVDATA* p_env)
{
	#ifdef DEBUG_TLOG
	double   elapsed_time;
	unsigned int sec, millisec;
	struct timeb timebuffer;
	char logbuf[50];
	
	if( 0 == isTimer(p_env->time_log_str,p_env->time_log_stp) ){
		return;
	}
	
	ftime( &timebuffer );
	sec = timebuffer.time;
	millisec = sec * 1000 + timebuffer.millitm;
	
	sprintf(logbuf,"TLOG,%s,%u\0",p,millisec);
	output_ap_err(__FUNCTION__,__FILE__, __LINE__, logbuf,G_CMD_COM_PARAM.seq);
	#endif
}













int		main( int argc, char *argv[] )
{

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	uid[1024+1];		
		varchar	dbcon1[10];
	EXEC SQL END DECLARE SECTION;

	char *pFileNm;
	char *pBuf;
	FILE *fp;
	fpos_t fsize;
	int work;
	int ret;
	ENVDATA	env;					
	char	srcdir[1024+1];			
	char	wrkdir[1024+1];			
	char	lockfile[1024+1];		
	char	errmsg[2048];			
	int		errflag;				
	int		loopflg;				
	char	filename[1024+1];		
	int		msgid;					
	MSGBUF	msg;					
	char	*p;

	
	if(0 != atexit(exit_proc)){
#ifdef DEBUG
printf("[%s][Line:%04d]atexit err\n", __FUNCTION__,__LINE__);
#endif
		output_ap_err(__FUNCTION__,__FILE__, __LINE__, "atexit err" );
		return -1;
	}

	memset(&G_PROC_COM_PARAM,0x00,sizeof(G_PROC_COM_PARAM));
	memset(&env,0x00,sizeof(env));
	
	
	strcpy(G_PROC_COM_PARAM.proc,p_progid);
	G_CMD_COM_PARAM.seq = -1;
	
	
	p = strrchr(argv[0],'/');
	if(NULL == p){
		p = argv[0];
	}else{
		p++;
	}
	strcpy(G_PROC_COM_PARAM.exec_proc,p);
	
	pFileNm = NULL;
	pBuf = NULL;
	fp = NULL;
	resetAlloc_point();
	
	
	output_sys_info(__FUNCTION__,__FILE__,__LINE__,"START MAIN",G_CMD_COM_PARAM.seq);

	
	sprintf( env.mail_set_dir, MAIL_SETDIR, p_eventcd );
	sprintf( env.mail_work_dir, MAIL_WORKDIR, p_eventcd );

	
	sprintf( env.lock_file_name , LOCK_FILENAME, p_eventcd );
	
	
	strcpy( env.time_log_str , "9999");
	strcpy( env.time_log_stp , "9999");
	
	
	if( getenvdata( &env ) ){
		return( -1 );
	}
	
	
	
	strcpy( srcdir,env.mail_set_dir);
	
	strcpy( wrkdir,env.mail_work_dir);
	
	strcpy( lockfile , env.lock_file_name );
	
#ifdef DEBUG
printf( "set_mail DIR = [%s]\n", srcdir );
printf( "work_mail DIR = [%s]\n", wrkdir );
printf( "Oracle string = [%s]\n", env.oracle_connect_string );
#endif

#ifdef DEBUG
printf( "lock file = [%s]\n", lockfile );
#endif

	
	if( crelockfile( lockfile, &lockfd ) ){
#ifdef DEBUG
printf( "[%s] exist.\n",lockfile);
#endif
		output_ap_err(__FUNCTION__,__FILE__, __LINE__, "LOCK_FILE exist." );
		return( -2 );
	}
	
	
	strcpy( uid.arr, env.oracle_connect_string );
	uid.len = strlen( env.oracle_connect_string );
	
	
	msgid = msgget( env.mail_msg_ky, 0666|IPC_CREAT );
	if( -1 == msgid ){				
		sprintf( errmsg, "���b�Z�[�WID�̎擾�Ɏ��s���܂����BID=%ld", env.mail_msg_ky );
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, errmsg ,G_CMD_COM_PARAM.seq);
		close( lockfd );
		return( -3 );
	}
    
    strcpy(AT_DBCON_1,DBCON_1);
    
	
	EXEC SQL CONNECT :uid;
	
	
	
	while( 1 ){
		
		
		
		
		if( -1 == msgrcv( msgid, &msg, 4, 0, 0 ) ){
			sprintf( errmsg, "���b�Z�[�W��M�Ɏ��s���܂����B");
			output_sys_err(__FUNCTION__,__FILE__, __LINE__, errmsg ,G_CMD_COM_PARAM.seq );
			close( lockfd );
			return( -4 );
		}

		
		if( !strcmp( msg.mtext, "end" ) ){
#ifdef DEBUG
printf( "end message....\n");
#endif
			output_ap_err(__FUNCTION__,__FILE__, __LINE__, "end message ...." );
			break;
		}

		
		if( strcmp( msg.mtext, "get" ) ){	
			sprintf( errmsg, "����`�̃��b�Z�[�W[%s]����M���܂����B", msg.mtext);
			output_ap_err(__FUNCTION__,__FILE__, __LINE__, errmsg );
			continue;						
		}

		
		if( NULL == ( fp = fopen( lockfile, "r" ) ) ){
			
			
			sprintf( errmsg, "���b�N�t�@�C�������݂��܂���B");
			output_sys_err(__FUNCTION__,__FILE__, __LINE__, errmsg ,G_CMD_COM_PARAM.seq );
			close( lockfd );
			return( -10 );
		}
		fclose( fp );

		errflag = 0;
		loopflg = 1;
		while( 1 == loopflg ){
			tlog("START",&env);
			
			
			init_cmd_param();
			
			G_CMD_COM_PARAM.seq = -1;
			G_CMD_COM_PARAM.keiho_stop = 0;	

#ifdef DEBUG
printf( "[%s] - getfilelist \n", __FUNCTION__ );
#endif
			tlog("GETFILELIST",&env);
			
			ret = getfilelist( srcdir, filename );
#ifdef DEBUG
printf( "[%s]getfilelist ret =%ld\n", __FUNCTION__, ret);
#endif
			switch( ret ){
				case	0:				
#ifdef DEBUG
printf( "no files\n");
#endif
					G_CMD_COM_PARAM.mail_file_nm[0] = '\0';
					loopflg = 0;
					break;
				case	-1:				
#ifdef DEBUG
printf( "system call error. \n");
#endif
					G_CMD_COM_PARAM.mail_file_nm[0] = '\0';
					loopflg = 0;
					errflag = -1;
					break;
				default:				
					
					while(isPauseTimer(&env)){
						
						sleep(60);
					}
					
#ifdef DEBUG
printf( "file [%s]\n", filename);
#endif
					strcpy( G_CMD_COM_PARAM.mail_file_nm, filename );
					
					tlog("GETDATA",&env);
					ret = getdata( srcdir, wrkdir, filename, &env );
#ifdef DEBUG
printf( "getdata end[ret:%d]\n", ret);
#endif
					if( -1 == ret ){
						errflag = -1;
					}
					
					
					
					
					
					
					break;
			}
			if( errflag ){
				close( lockfd );
				return( -9 );
			}
			freeAlloc_point();
		}
		
	}
	freeAlloc_point();
	
	
	close( lockfd );
	return( 0 );
}












void exit_proc()
{
#ifdef DEBUG
printf("[%s][Line:%04d]Bye\n", __FUNCTION__,__LINE__);
#endif

	
	output_sys_err(__FUNCTION__,__FILE__,__LINE__,"ml_ent end!!!!",G_CMD_COM_PARAM.seq);

	freeAlloc_point();
	close( lockfd );
}












int		getenvdata( ENVDATA *p_env )
{
	char	*p_work;					
	struct stat buf;					
	char	logmsg[2048];				
	int idx = 0;
	char	*ptok;

	
	p_work = getenv( "MAIL_MSG_KY" );
	if( NULL == p_work ){
		output_sys_err(__FUNCTION__,__FILE__, __LINE__,
				"���ϐ�[MAIL_MSG_KY]���擾�ł��܂���ł����B",G_CMD_COM_PARAM.seq);
		return( -1 );
	}
	p_env->mail_msg_ky = atoi( p_work );

	
	p_work = getenv( "ORACLE_CONNECT_STRING" );
	if( NULL == p_work ){
		output_sys_err(__FUNCTION__,__FILE__, __LINE__,
				"���ϐ�[ORACLE_CONNECT_STRING]���擾�ł��܂���ł����B",G_CMD_COM_PARAM.seq);
		return( -1 );
	}
	strcpy( p_env->oracle_connect_string, p_work );

	
	p_work = getenv( "SND_ML_SHELL" );
	if( NULL == p_work ){
		output_sys_err(__FUNCTION__,__FILE__, __LINE__,
				"���ϐ�[SND_ML_SHELL]���擾�ł��܂���ł����B",G_CMD_COM_PARAM.seq);
		return( -1 );
	}
	
	if( -1 == stat( p_work, &buf ) ){
		output_sys_err(__FUNCTION__,__FILE__, __LINE__,
				"�x��ʒm���[�����M�V�F�����擾�ɂăG���[���������܂����B",G_CMD_COM_PARAM.seq);
		return( -1 );
	}
	strcpy( p_env->snd_ml_shell, p_work );

	
	p_work = getenv( "FROM_ADDRESS" );
	if( NULL == p_work ){
		output_sys_err(__FUNCTION__,__FILE__, __LINE__,
				"env[FROM_ADDRESS] is not setting....",G_CMD_COM_PARAM.seq);
		return( -1 );
	}
	strcpy( p_env->from_address, p_work );

	
	p_work = getenv( "REPLY_TO_ADDRESS" );
	if( NULL == p_work ){
		output_sys_err(__FUNCTION__,__FILE__, __LINE__,
				"env[REPLY_TO_ADDRESS] is not setting....",G_CMD_COM_PARAM.seq);
		return( -1 );
	}
	strcpy( p_env->reply_address, p_work );

	
	p_work = getenv( "MAIL_SET_DIR" );
	if( NULL != p_work ){
		strcpy( p_env->mail_set_dir, p_work );
	}else{
		sprintf( logmsg, "env[%s] is not setting....default[%s]"
				, "MAIL_SET_DIR"
				, p_env->mail_set_dir );
		output_ap_err(__FUNCTION__,__FILE__, __LINE__, logmsg,G_CMD_COM_PARAM.seq);
	}

	
	p_work = getenv( "MAIL_WORK_DIR" );
	if( NULL != p_work ){
		strcpy( p_env->mail_work_dir, p_work );
	}else{
		sprintf( logmsg, "env[%s] is not setting....default[%s]"
				, "MAIL_WORK_DIR"
				, p_env->mail_work_dir );
		output_ap_err(__FUNCTION__,__FILE__, __LINE__, logmsg,G_CMD_COM_PARAM.seq);
	}

	
	p_work = getenv( "LOCK_FILE_NAME" );
	if( NULL != p_work ){
		strcpy( p_env->lock_file_name, p_work );
	}else{
		sprintf( logmsg, "env[%s] is not setting....default[%s]"
				, "LOCK_FILE_NAME"
				, p_env->lock_file_name );
		output_ap_err(__FUNCTION__,__FILE__, __LINE__, logmsg,G_CMD_COM_PARAM.seq);
	}
	
	p_work = getenv( "TIME_LOG_STR" );
	if( NULL != p_work ){
		strcpy( p_env->time_log_str, p_work );
	}else{
		sprintf( logmsg, "env[%s] is not setting....default[%s]"
				, "TIME_LOG_STR"
				, p_env->time_log_str );
		output_ap_err(__FUNCTION__,__FILE__, __LINE__, logmsg,G_CMD_COM_PARAM.seq);
	}
	
	
	p_work = getenv( "TIME_LOG_STP" );
	if( NULL != p_work ){
		strcpy( p_env->time_log_stp, p_work );
	}else{
		sprintf( logmsg, "env[%s] is not setting....default[%s]"
				, "TIME_LOG_STP"
				, p_env->time_log_stp );
		output_ap_err(__FUNCTION__,__FILE__, __LINE__, logmsg,G_CMD_COM_PARAM.seq);
	}
	
	
	idx = 0;
	p_work = getenv( "PAUSE_STR_TIMES" );
	if( NULL != p_work ){
		ptok = strtok(p_work,",");
		while(NULL!=ptok && idx < PAUSE_TIMES_MAX){
			strcpy(p_env->pause_str_times[idx],ptok);
			idx ++;
			ptok = strtok(NULL,",");
		}
	}
	
	
	idx = 0;
	p_work = getenv( "PAUSE_STP_TIMES" );
	if( NULL != p_work ){
		ptok = strtok(p_work,",");
		while(NULL!=ptok && idx < PAUSE_TIMES_MAX){
			strcpy(p_env->pause_stp_times[idx],ptok);
			idx ++;
			ptok = strtok(NULL,",");
		}
	}
	

	
	return( 0 );
}
















int		getdata( char* p_srcdir, char* p_dstdir, char* p_infile, ENVDATA* p_env )
{
	FILE	*fp;					
	char	filename[1024];			
	int		ret;					
	char	errmsg[2048];			
	char	*p_tel;					
	char	*p_dummy;				
	char	telno[128];				
	struct	stat	st;					
	MAIL_INFO	mlinfo;				


#ifdef DEBUG
printf( "[%s]srcdir = %s\n", __FUNCTION__, p_srcdir );
printf( "[%s]dstdir = %s\n", __FUNCTION__, p_dstdir );
printf( "[%s]filename = %s\n", __FUNCTION__, p_infile );
#endif
	tlog("MOVEFILE",p_env);
	
	if( movefile( p_srcdir, p_dstdir, p_infile ) ){
		return( -1 );
	}
	
	strcpy( filename, p_dstdir );
	strcat( filename, p_infile );

	tlog("STAT",p_env);
	
	if( -1 == stat( filename, &st ) ){
		sprintf( errmsg, "�t�@�C�����擾�Ɏ��s���܂����Bfilename=[%s]", filename );
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, errmsg ,G_CMD_COM_PARAM.seq);
		return( -1 );
	}
	
	if( 0 == st.st_size ){
		return( 0 );
	}

	tlog("FOPEN",p_env);
	if( NULL == ( fp = fopen( filename, "r" ) ) ){
		sprintf( errmsg, "�t�@�C���̓ǂݍ��݃��[�h�I�[�v���Ɏ��s���܂����Bfilename[=%s]", filename );
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, errmsg ,G_CMD_COM_PARAM.seq);
		return( -1 );
	}

	tlog("GET_MAIL_INFO",p_env);
	
	memset( ( void* )&mlinfo, 0x00, sizeof( mlinfo ) );
	ret = get_mail_info( &mlinfo, &fp, st.st_size+2 );
	if( -1 == ret ){
		sprintf( errmsg, "���[���w�b�_���擾���s�ׁ̈A�������I���v���܂��Bfilename[=%s]", filename );
		output_ap_err(__FUNCTION__,__FILE__, __LINE__, errmsg ,G_CMD_COM_PARAM.seq);
		fclose( fp );
		return( -1 );
	}
	
	if( 1 == ret ){						
		sprintf( errmsg, "���[���w�b�_From�ُ�ׁ̈A���t�@�C�����������܂��B�Bfilename[=%s]", filename );
		output_ap_err(__FUNCTION__,__FILE__, __LINE__, errmsg ,G_CMD_COM_PARAM.seq);
		fclose( fp );
		return( 1 );
	}

#ifdef DEBUG
	printf( "[%s]ML-Head start\n", __FUNCTION__);
	printf( "[%s]ML-Head(header)=[%s]\n", __FUNCTION__, mlinfo.header );
	printf( "[%s]ML-Head(body)=[%s]\n", __FUNCTION__, mlinfo.body );
	printf( "[%s]ML-Head(from_mailaddr)=[%s]\n", __FUNCTION__, mlinfo.from_mailaddr );
	printf( "[%s]ML-Head(to_mailaddr)=[%s]\n", __FUNCTION__, mlinfo.to_mailaddr );
	printf( "[%s]ML-Head(body_to_mailaddr)=[%s]\n", __FUNCTION__, mlinfo.body_to_mailaddr );
	printf( "[%s]ML-Head end \n", __FUNCTION__);
#endif

	tlog("TRIM_BRACKETS",p_env);
	
	
	
	
	trim_brackets(mlinfo.to_mailaddr,G_CMD_COM_PARAM.to_mailaddr);
	
	
	G_CMD_COM_PARAM.mail_type_flg = 9;
	
	
	G_CMD_COM_PARAM.mail_ng_flg = 0;
	if(1 == mlinfo.nc_status_ng
	|| 1 == mlinfo.no_mailbox){
		
		G_CMD_COM_PARAM.mail_ng_flg = 1;
		strcpy(G_CMD_COM_PARAM.mail_type,MTYP_NG);
		strcpy(G_CMD_COM_PARAM.mail_type_forlog,"NG");
	}
	
	
	if(1 == G_CMD_COM_PARAM.mail_ng_flg){
		
		
		
		if(strlen(mlinfo.body_to_mailaddr)){
			
			
			trim_brackets(mlinfo.body_to_mailaddr,G_CMD_COM_PARAM.from_mailaddr);
			
		}else{
			
			
			trim_brackets(mlinfo.from_mailaddr,G_CMD_COM_PARAM.from_mailaddr);
			
		}
	}else{
		
		
		trim_brackets(mlinfo.from_mailaddr,G_CMD_COM_PARAM.from_mailaddr);
		
	}
	
	
	strcpy(mlinfo.from_mailaddr,G_CMD_COM_PARAM.from_mailaddr);
	
#ifdef DEBUG
	printf( "[%s]From,To bfo G_CMD_COM_PARAM.from_mailaddr=%s\n", __FUNCTION__, G_CMD_COM_PARAM.from_mailaddr );
	printf( "[%s]From,To aft G_CMD_COM_PARAM.to_mailaddr=%s\n", __FUNCTION__, G_CMD_COM_PARAM.to_mailaddr );
#endif
	
	
	strcpy(mlinfo.sr_typ,"R");;
	
	strcpy(mlinfo.mail_typ,"9");;
	
	mlinfo.s_flg = 9;

#ifdef DEBUG
printf( "[%s]G_CMD_COM_PARAM.tel_no=%s\n", __FUNCTION__, G_CMD_COM_PARAM.tel_no );
#endif
	
	
	
	
	
	ret = 0;
	
	
	
	tlog("ADDMAILLOG",p_env);
	ret = addmaillog(&mlinfo);
	if(!ret){
		EXEC SQL COMMIT;
	}else if(-2 == ret){
		
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, G_CMD_COM_PARAM.err_msg ,G_CMD_COM_PARAM.seq);
		
		if( movefile( p_dstdir, p_srcdir, p_infile ) ){
			return( -1 );
		}
		
		fclose( fp );
		return -1;
	}else if(-1 == ret){
		
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, G_CMD_COM_PARAM.err_msg ,G_CMD_COM_PARAM.seq);
		EXEC SQL ROLLBACK;
		
		fclose( fp );
		return -1;
	}else if(2 == ret){
		
		EXEC SQL ROLLBACK;
		
		fclose( fp );
		return 1;
	}else{
		
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, G_CMD_COM_PARAM.err_msg ,G_CMD_COM_PARAM.seq);
		EXEC SQL ROLLBACK;
		
		fclose( fp );
		return 1;
	}
	
	
	if(1 != G_CMD_COM_PARAM.mail_ng_flg){

		ret = 0;
		
		
		
		tlog("YYPARSE",p_env);
		fseek(fp,0,SEEK_SET);
		yyin = fp;
		ret = yyparse ();
		if(!ret){
			
			#ifdef DEBUG
			output_sys_info(__FUNCTION__,__FILE__, __LINE__, "YYPARSE-END" ,G_CMD_COM_PARAM.seq);
			#endif
		}else{
			
			output_sys_err(__FUNCTION__,__FILE__, __LINE__, G_CMD_COM_PARAM.err_msg ,G_CMD_COM_PARAM.seq);
			output_sys_err(__FUNCTION__,__FILE__, __LINE__, "YYPARSE-ERROR" ,G_CMD_COM_PARAM.seq);
			EXEC SQL ROLLBACK;
			
			fclose( fp );
			return 1;
		}
	}

	
	
	
    ret = mail_filter(&mlinfo, p_env);
	if(!ret){
		
		#ifdef DEBUG
		output_ap_err(__FUNCTION__,__FILE__, __LINE__, "mail_filter(end)" ,G_CMD_COM_PARAM.seq);
		#endif
	}else if(-2 == ret){
		
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, G_CMD_COM_PARAM.err_msg ,G_CMD_COM_PARAM.seq);
		
		if( movefile( p_dstdir, p_srcdir, p_infile ) ){
			return( -1 );
		}
		
		fclose( fp );
		return -1;
	}else if(-1 == ret){
		
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, G_CMD_COM_PARAM.err_msg ,G_CMD_COM_PARAM.seq);
		EXEC SQL ROLLBACK;
		
		fclose( fp );
		return -1;
	}else{
		
		output_ap_err(__FUNCTION__,__FILE__,__LINE__,G_CMD_COM_PARAM.err_msg);
		EXEC SQL ROLLBACK;
		
		fclose( fp );
		return 1;
	}

	
	
	
	
	tlog(G_CMD_COM_PARAM.mail_type,p_env);
	ret = mail_type_main (G_CMD_COM_PARAM.mail_type);
	
	
	
	
	fclose( fp );
	if(!ret){
		
		#ifdef DEBUG
		output_sys_info(__FUNCTION__,__FILE__, __LINE__, "MAIL<SUCCESS>" ,G_CMD_COM_PARAM.seq);
		#endif
	}else if(-2 == ret){
		
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, G_CMD_COM_PARAM.err_msg ,G_CMD_COM_PARAM.seq);
		
		if( movefile( p_dstdir, p_srcdir, p_infile ) ){
			return( -1 );
		}
		return -1;
	}else if(-1 == ret){
		
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, G_CMD_COM_PARAM.err_msg ,G_CMD_COM_PARAM.seq);
		EXEC SQL ROLLBACK;
		return -1;
	}else{
		
		output_ap_err(__FUNCTION__,__FILE__,__LINE__,G_CMD_COM_PARAM.err_msg);
		EXEC SQL ROLLBACK;
		return 1;
	}
	
    
    
    
    tlog("CHECKUP_MAIL-STR",p_env);
    checkup_mail(G_PROC_COM_PARAM.proc,G_CMD_COM_PARAM.equip_no,G_CMD_COM_PARAM.mail_type, p_env);

	
	
	
	tlog("KEIHO_MAIL-STR",p_env);
	if(0 == G_CMD_COM_PARAM.keiho_stop){
		keiho_mail(G_PROC_COM_PARAM.proc,G_CMD_COM_PARAM.equip_no,G_CMD_COM_PARAM.mail_type, p_env);
	}

	
	strcpy(mlinfo.mail_typ,G_CMD_COM_PARAM.mail_type_forlog);
	
	mlinfo.s_flg = 1;


	ret = 0;
	
	
	
	tlog("UPDMAILLOG",p_env);
	ret = updmaillog(&mlinfo);

	if(!ret){
		EXEC SQL COMMIT;
	}else if(-2 == ret){
		
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, G_CMD_COM_PARAM.err_msg ,G_CMD_COM_PARAM.seq);
		
		if( movefile( p_dstdir, p_srcdir, p_infile ) ){
			return( -1 );
		}
		return -1;
	}else if(-1 == ret){
		
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, G_CMD_COM_PARAM.err_msg ,G_CMD_COM_PARAM.seq);
		EXEC SQL ROLLBACK;
		return -1;
	}else{
		
		output_sys_err(__FUNCTION__,__FILE__, __LINE__, G_CMD_COM_PARAM.err_msg ,G_CMD_COM_PARAM.seq);
		EXEC SQL ROLLBACK;
		return 1;
	}
	output_ap_err(__FUNCTION__,__FILE__, __LINE__, filename ,G_CMD_COM_PARAM.seq);

	tlog("UNLINK",p_env);
	unlink( filename );				

	
	return( 0 );
}
















int checkup_mail(char *proc_nm,char *p_equip_no,char *p_mail_type, ENVDATA* p_env){
  EXEC SQL BEGIN DECLARE SECTION;
    varchar    equip_no[20];
    varchar    alarm_cd[5];
    varchar    error_cd[20+1];
    varchar    from_address[1024+1];
    varchar    to_address[1024+1];
    varchar    subject[3072+1];
    varchar    mail_body[3072+1];
    varchar    additional_header[1024+1];
    char       body_decode[1+1];
    int        send_flg;
    varchar    mail_address[1024+1];
    varchar    lcid[5+1];
    varchar    key_dt[20];                   
  EXEC SQL END DECLARE SECTION;
  char      program_name[1024+1];
  int       ret;
  char      errmsg[2048];
  char      cmd[8192];
  int       sret;

#ifdef DEBUG
printf("[%s][Line:%04d]checkup_mail -- start\n", __FUNCTION__,__LINE__);
printf("[%s][Line:%04d]param(proc_nm)[%s]\n", __FUNCTION__,__LINE__,proc_nm);
printf("[%s][Line:%04d]param(p_equip_no)[%s]\n", __FUNCTION__,__LINE__,p_equip_no);
printf("[%s][Line:%04d]param(p_mail_type)[%s]\n", __FUNCTION__,__LINE__,p_mail_type);
printf("[%s][Line:%04d]DATE[%s]\n", __FUNCTION__,__LINE__,G_CMD_COM_PARAM.mail_date);
#endif

  
  strcpy(equip_no.arr,p_equip_no);
  equip_no.len = strlen(p_equip_no);

  if(0 != strcmp(p_mail_type,MTYP_HDHQHP)){
    
    return 0;
  }

  if(0 != strcmp(G_CMD_FDFR_REC[0].value00,"HP")){
    
    return 0;
  }




  
  strcpy(key_dt.arr,G_CMD_FDFR_REC[0].value02);
  key_dt.len = strlen(G_CMD_FDFR_REC[0].value02);


  
  
  strcpy(alarm_cd.arr,"HP");
  alarm_cd.len = strlen("HP");
  strcpy(error_cd.arr,"HP");
  error_cd.len = strlen("HP");



#ifdef DEBUG
printf("[%s][Line:%04d]EQUIP_NO[%s]\n", __FUNCTION__,__LINE__,equip_no.arr);
printf("[%s][Line:%04d]KEY1[%s]\n", __FUNCTION__,__LINE__,key_dt.arr);
printf("[%s][Line:%04d]ALARM_CD[%s]\n", __FUNCTION__,__LINE__,alarm_cd.arr);
printf("[%s][Line:%04d]ERROR_CD[%s]\n", __FUNCTION__,__LINE__,error_cd.arr);
#endif

  
  
  EXEC SQL
      DECLARE C1_CHK CURSOR FOR
          SELECT DISTINCT
                 LOWER(ima.MAIL_ADDRESS) AS MAIL_ADDRESS
                ,ima.LCID
            FROM ITS_MAIL_ADDR ima
           WHERE 1 = ISSEND_ITS_MAIL_ADDR(ima.CUST_CD, ima.SEQ, :equip_no, :alarm_cd, :error_cd, '')
        ORDER BY LOWER(ima.MAIL_ADDRESS), ima.LCID;

  EXEC SQL open C1_CHK;
  if (sqlca.sqlcode) {
    strcpy( errmsg, "open C1_CHK");
    output_ap_err(__FUNCTION__,__FILE__, __LINE__,errmsg);
    return(2);
  }

  while(1) {

    mail_address.len = 0;
    lcid.len = 0;

    EXEC SQL FETCH C1_CHK into
             :mail_address
            ,:lcid
    ;
    if (1403 == sqlca.sqlcode)  break;
    mail_address.arr[mail_address.len] = 0x00;
    lcid.arr[lcid.len] = 0x00;

#ifdef DEBUG
printf("[%s][Line:%04d]FETCH[%s][%s]\n", __FUNCTION__,__LINE__,mail_address.arr,lcid.arr);
#endif

    to_address.len = 0;
    subject.len = 0;
    mail_body.len = 0;
    additional_header.len = 0;
    body_decode[0] = 0x00;

    
    
    EXEC SQL EXECUTE
        BEGIN
            GET_NOTIFICATION_CKUP(:equip_no, :key_dt , :alarm_cd, :mail_address, :lcid,
                                  :to_address, :subject, :mail_body, :additional_header, :body_decode);
        END;
    END-EXEC;

    to_address.arr[to_address.len] = 0x00;
    subject.arr[subject.len] = 0x00;
    mail_body.arr[mail_body.len] = 0x00;
    additional_header.arr[additional_header.len] = 0x00;
    body_decode[1] = 0x00;

    send_flg = 0;

    sprintf(cmd, "%s '%s' '%s' '%s' '%s' '%s' '%s'",
            p_env->snd_ml_shell
           ,p_env->from_address
           ,to_address.arr
           ,subject.arr
           ,mail_body.arr
           ,additional_header.arr
           ,body_decode
    );

#ifdef DEBUG
printf("[%s][Line:%04d]CMD[%s]\n", __FUNCTION__,__LINE__,cmd);
#endif

    sret = system(cmd);
    if (sret) {
      output_sys_err(__FUNCTION__,__FILE__, __LINE__, "�ڋq���[�����M�V�F�����N���ł��܂���B" ,G_CMD_COM_PARAM.seq);
    }

  }

#ifdef DEBUG
printf("[%s][Line:%04d]checkup_mail -- end\n", __FUNCTION__,__LINE__);
#endif

}















int keiho_mail(char *proc_nm,char *p_equip_no,char *p_mail_type, ENVDATA* p_env){
	EXEC SQL BEGIN DECLARE SECTION;
		varchar		equip_no[20];
		varchar		alarm_cd[5];
		varchar		error_cd[20+1];
		int			alarm_status;
		varchar		from_address[1024+1];
		varchar		to_address[1024+1];
		varchar		subject[3072+1];
		varchar		mail_body[3072+1];
		varchar		additional_header[1024+1];
		char		body_decode[1+1];
		varchar		hassei_dt[20];
		int			send_flg;
		char		alarm_grp_cd[2+1];
		varchar		cust_cd[10];		
		varchar		chk_send[2+1];
	EXEC SQL END DECLARE SECTION;
	char			program_name[1024+1];
	int				ret;
	char			errmsg[2048];
	char			cmd[8192];
	int				sret;

#ifdef DEBUG
printf("[%s][Line:%04d]keiho_mail -- start\n", __FUNCTION__,__LINE__);
printf("[%s][Line:%04d]param(proc_nm)[%s]\n", __FUNCTION__,__LINE__,proc_nm);
printf("[%s][Line:%04d]param(p_equip_no)[%s]\n", __FUNCTION__,__LINE__,p_equip_no);
printf("[%s][Line:%04d]param(p_mail_type)[%s]\n", __FUNCTION__,__LINE__,p_mail_type);
#endif
#ifdef DEBUG
printf("[%s][Line:%04d]DATE[%s]\n", __FUNCTION__,__LINE__,G_CMD_COM_PARAM.mail_date);
#endif
	
	
	strcpy(equip_no.arr,p_equip_no);
	equip_no.len = strlen(p_equip_no);
	
	if(0 == strcmp(p_mail_type,MTYP_SC)){
		
		
		
		strcpy(alarm_cd.arr,"SC");
		alarm_cd.len = strlen("SC");
		strcpy(error_cd.arr,"SC");
		error_cd.len = strlen("SC");
		
		alarm_status = 1;
		
	}else if(0 == strcmp(p_mail_type,MTYP_SA)){

		
		
		strcpy(alarm_cd.arr,"SA");
		alarm_cd.len = strlen("SA");
		strcpy(error_cd.arr,"SA");
		error_cd.len = strlen("SA");
		
		alarm_status = G_CMD_SA_PARAM.abnormal_flg;

	}else if(0 == strcmp(p_mail_type,MTYP_BT)){

		
		
		strcpy(alarm_cd.arr,"BT");
		alarm_cd.len = strlen("BT");
		strcpy(error_cd.arr,"BT");
		error_cd.len = strlen("BT");
		
		alarm_status = G_CMD_BT_PARAM.abnormal_flg;

	}else if(0 == strcmp(p_mail_type,MTYP_SS)){

		
		
		strcpy(alarm_cd.arr,"SS");
		alarm_cd.len = strlen("SS");
		strcpy(error_cd.arr,"SS");
		error_cd.len = strlen("SS");
		
		if(!strcmp(G_CMD_SS_PARAM.value01,"1")){
		    alarm_status = 1;
		}else{
		    alarm_status = 0;
		}

	}else if(0 == strcmp(p_mail_type,MTYP_SR)){

		
		
		strcpy(alarm_cd.arr,"SR");
		alarm_cd.len = strlen("SR");
		strcpy(error_cd.arr,"SR");
		error_cd.len = strlen("SR");
		
		if(!strcmp(G_CMD_SR_PARAM.value01,"1")){
		    alarm_status = 1;
		}else{
		    alarm_status = 0;
		}

	}else if(0 == strcmp(p_mail_type,MTYP_SG)){

		
		
		strcpy(alarm_cd.arr,"SG");
		alarm_cd.len = strlen("SG");
		strcpy(error_cd.arr,"SG");
		error_cd.len = strlen("SG");
		
		if(!strcmp(G_CMD_SG_PARAM.value01,"1")){
		    alarm_status = 1;
		}else{
		    alarm_status = 0;
		}

	}else if(0 == strcmp(p_mail_type,MTYP_SU)){

		
		
		strcpy(alarm_cd.arr,"SU");
		alarm_cd.len = strlen("SU");
		strcpy(error_cd.arr,"SU");
		error_cd.len = strlen("SU");
		
		if(!strcmp(G_CMD_SU_PARAM.value01,"1")){
		    alarm_status = 1;
		}else{
		    alarm_status = 0;
		}

	}else if(0 == strcmp(p_mail_type,MTYP_XX)
			|| 0 == strcmp(p_mail_type,MTYP_XX_V7)){

		
		
		
		strcpy(alarm_cd.arr,G_CMD_XX_PARAM.alarm_cd);
		alarm_cd.len = strlen(G_CMD_XX_PARAM.alarm_cd);
		strcpy(error_cd.arr,G_CMD_XX_PARAM.error_cd);
		error_cd.len = strlen(G_CMD_XX_PARAM.error_cd);
		
		alarm_status = G_CMD_XX_PARAM.alarm_status;

	}else{
		
		return 0;
	}
	
	
	sprintf(hassei_dt.arr, "%s", G_CMD_COM_PARAM.mail_date);
	hassei_dt.len = strlen(hassei_dt.arr);
	
	
	chk_send.arr[0] = 0x00;
	chk_send.len = 0;
	
#ifdef DEBUG
printf("[%s][Line:%04d]MAIL.BODY_DATE(hassei_dt)[%s]\n", __FUNCTION__,__LINE__,hassei_dt.arr);
printf("[%s][Line:%04d]EQUIP_NO[%s]\n", __FUNCTION__,__LINE__,equip_no.arr);
printf("[%s][Line:%04d]ALARM_CD[%s]\n", __FUNCTION__,__LINE__,alarm_cd.arr);
printf("[%s][Line:%04d]ERROR_CD[%s]\n", __FUNCTION__,__LINE__,error_cd.arr);
printf("[%s][Line:%04d]EVENT[%d]\n", __FUNCTION__,__LINE__,alarm_status);
#endif
	
    
    
    EXEC SQL EXECUTE
        BEGIN
            MAIL.BODY_DATE(to_date(:hassei_dt,'yyyymmddhh24miss'));
            MAIL.CHK_KEIHOU_MAIL(:equip_no,:alarm_cd,:error_cd,:alarm_status,:chk_send);
        END;
    END-EXEC;
    chk_send.arr[chk_send.len] = 0x00;
    
    if (0 != strcmp(chk_send.arr,"OK")){
#ifdef DEBUG
printf("[%s][Line:%04d]keiho_mail -- �A���}�~(%s)\n", __FUNCTION__,__LINE__,chk_send.arr);
#endif
		
		return 0;
	}
    
    
	EXEC SQL
	declare C1 cursor for
	SELECT MAIL_ADDRESS AS TO_ADDRESS
	      ,SUBJECT AS SUBJECT
	      ,TEXT AS MAIL_BODY
	      ,ADDITIONAL_HEADER AS ADDITIONAL_HEADER
	      ,BODY_DECODE AS BODY_DECODE
	      ,ALARM_GRP_CD
	FROM V_M_NOTIFICATION
	WHERE 1 = 1
	  AND EQUIP_NO = :equip_no
	  AND ALARM_CD = :alarm_cd
	  AND ERROR_CD = :error_cd
	  AND EVENT = :alarm_status
	;

	EXEC SQL open C1;
	if (sqlca.sqlcode) {
		strcpy( errmsg, "open C1");
		output_ap_err(__FUNCTION__,__FILE__, __LINE__,errmsg);
		return(2);
	}

	while(1) {
		to_address.len = 0;
		subject.len = 0;
		mail_body.len = 0;
		additional_header.len = 0;
		body_decode[0] = 0x00;
		
		EXEC SQL FETCH C1 into
			 :to_address
			,:subject
			,:mail_body
			,:additional_header
			,:body_decode
			,:alarm_grp_cd
		;
		if (1403 == sqlca.sqlcode)  break;
		to_address.arr[to_address.len] = 0x00;
		subject.arr[subject.len] = 0x00;
		mail_body.arr[mail_body.len] = 0x00;
		additional_header.arr[additional_header.len] = 0x00;
		body_decode[1] = 0x00;
		
#ifdef DEBUG
printf("[%s][Line:%04d]FETCH[%s][%s][%s][%s][%s]\n", __FUNCTION__,__LINE__
		,to_address.arr
		,subject.arr
		,mail_body.arr
		,additional_header.arr
		,body_decode
		);
#endif
		
		send_flg = 0;
		
		sprintf(cmd, "%s '%s' '%s' '%s' '%s' '%s' '%s'",
				 p_env->snd_ml_shell
				,p_env->from_address
				,to_address.arr
				,subject.arr
				,mail_body.arr
				,additional_header.arr
				,body_decode
				);
#ifdef DEBUG
printf("[%s][Line:%04d]CMD[%s]\n", __FUNCTION__,__LINE__,cmd
		);
#endif

		sret = system(cmd);
		if (sret) {
			output_sys_err(__FUNCTION__,__FILE__, __LINE__, "�ڋq���[�����M�V�F�����N���ł��܂���B" ,G_CMD_COM_PARAM.seq);
		}
	
        
        
        EXEC SQL EXECUTE
            BEGIN
                MAIL.COUNTUP_KEIHOU_MAIL(:equip_no,:alarm_cd,:error_cd,:alarm_status);
            END;
        END-EXEC;
	}
	
#ifdef DEBUG
printf("[%s][Line:%04d]keiho_mail -- end\n", __FUNCTION__,__LINE__);
#endif
	

}




















int		mail_filter(MAIL_INFO* m_info, ENVDATA* p_env){

    char			errmsg[ORA_ERR_MSG_MAX_LEN + 1];
    int				msglen;
    int				buflen;
	char			cmd[8192];
	int				sret;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar		mail_body[BODY_MAX_LEN+1];				

		varchar		to_addr[100+1];							

		varchar		from_addr[100+1];						

		varchar		filter_key1[50+1];						
		short		ind_filter_key1;

		varchar		send_to_address[1000+1];				

		varchar		send_subject[3072+1];					

		varchar		send_mail_body[3072+1];					

		varchar		additional_header[1024+1];				
		
		char		body_decode[1+1];

		varchar		mail_typ[MAIL_TYP_MAX_LEN+1];			

	EXEC SQL END DECLARE SECTION;

	EXEC SQL WHENEVER SQLERROR GOTO sql_error;

#ifdef DEBUG
printf("[%s][Line:%04d]<FILTER>\n",__FUNCTION__,__LINE__);
#endif

	vcstrncpy(&filter_key1, "", strlen(""));
	ind_filter_key1 = 0;
	vcstrncpy(&to_addr, m_info->to_mailaddr, strlen(m_info->to_mailaddr));
	vcstrncpy(&from_addr, m_info->from_mailaddr, strlen(m_info->from_mailaddr));
	vcstrncpy(&mail_body, m_info->body, strlen(m_info->body));
	vcstrncpy(&mail_typ, m_info->mail_typ, strlen(m_info->mail_typ));
	vcstrncpy(&send_to_address, "", strlen(""));
	vcstrncpy(&send_subject, "", strlen(""));
	vcstrncpy(&send_mail_body, "", strlen(""));
	vcstrncpy(&additional_header, "", strlen(""));
	body_decode[0] = '0';
	body_decode[1] = 0x00;

#ifdef DEBUG
printf("[%s][Line:%04d]<CHK_FILTER_MAIL>[%s][%s][%s]\n",__FUNCTION__,__LINE__,to_addr.arr,from_addr.arr,mail_body.arr);
#endif


	EXEC SQL EXECUTE
		BEGIN
			CHK_FILTER_MAIL(     :to_addr
                                ,:from_addr
                                ,:mail_body
                                ,:filter_key1:ind_filter_key1);
		END;
	END-EXEC;

	filter_key1.arr[filter_key1.len] = 0x00;

	if(0 == filter_key1.len){
#ifdef DEBUG
printf("[%s][Line:%04d][%s] NO MATCH\n",__FUNCTION__,__LINE__,send_subject.arr);
#endif
		return (0);
	}

#ifdef DEBUG
printf("[%s][Line:%04d][%s] MATCH![%s]\n",__FUNCTION__,__LINE__,send_subject.arr,filter_key1.arr);
#endif

	
	EXEC SQL EXECUTE
		BEGIN
			GET_FILTER_MAIL_INFO(:filter_key1
                                ,:from_addr
                                ,:mail_body
                                ,:mail_typ
                                ,:send_to_address
                                ,:send_subject
                                ,:send_mail_body
                                ,:additional_header);
		END;
	END-EXEC;

	send_to_address.arr[send_to_address.len] = 0x00;
	send_subject.arr[send_subject.len] = 0x00;
	send_mail_body.arr[send_mail_body.len] = 0x00;
	additional_header.arr[additional_header.len] = 0x00;

#ifdef DEBUG
printf("[%s][Line:%04d][%s]\n",__FUNCTION__,__LINE__,send_subject.arr);
#endif



		sprintf(cmd, "%s '%s' '%s' '%s' '%s' '%s' '%s'",
				 p_env->snd_ml_shell
				,p_env->from_address
				,send_to_address.arr
				,send_subject.arr
				,send_mail_body.arr
				,additional_header.arr
				,body_decode
				);

#ifdef DEBUG
printf("[%s][Line:%04d]CMD[%s]\n", __FUNCTION__,__LINE__,cmd
		);
#endif

		sret = system(cmd);
		if (sret) {
			output_sys_err(__FUNCTION__,__FILE__, __LINE__, "mail_filter system(cmd) error" ,G_CMD_COM_PARAM.seq);
			return( 9 );
		}
	



	return( 0 );

sql_error:

    
    buflen = ORA_ERR_MSG_MAX_LEN;
    sqlglm( errmsg, &buflen, &msglen );
    errmsg[msglen] = '\0';
	
	sprintf(G_CMD_COM_PARAM.err_msg,"mail_filter[%s]",errmsg);

#ifdef DEBUG
printf("[%s][Line:%04d]mail_filter error[%s]\n",__FUNCTION__,__LINE__,errmsg);
#endif

    
    return( chk_oraerr( sqlca.sqlcode ) );
}


